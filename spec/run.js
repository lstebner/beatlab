(function(){var e,t,r,n,o,i,s,u,a,d,c,l,h,p,f,_;n=require("underscore"),o=require("underscore.string"),t={express:require("express"),http:require("http"),path:require("path"),mongoose:require("mongoose"),fs:require("fs")},t.Schema=t.mongoose.Schema,e=function(){function e(e){null==e&&(e={}),this.env=u.env.NODE_ENV,this.site_name=e.site_name,this.config=e.config,this.app=e.app,this.mongoose=e.mongoose,this.config=n.extend(r,this.config||{}),this.load_environment_config(),this.setup()}var r,o,i,s;return s=t.fs,i=t.express,r={title:"",base_url:"",meta_keywords:"",meta_description:"",css_version:1,js_version:1,port:3e3,debug:!1},o=__dirname.replace(/spec(\/|)/,""),e.set_site=function(e){this.site=e},e.init=function(t,r){return null==t&&(t={}),null==r&&(r=e),r===e?this.site=new e(t):this.site=r.init(t)},e.slugify=function(e,t){var r,n;return r="-",n=e.toString().replace(/[\s\.]+/g,r).toLowerCase().replace(new RegExp("[^a-z0-9"+r+"]","g"),r).replace(new RegExp(r+"+","g"),r),n.charAt(n.length-1)===r&&(n=n.substring(0,n.length-1)),n.charAt(0)===r&&(n=n.substring(1)),null!=t?n+"-"+t.getDate()+"-"+(t.getMonth()+1)+"-"+t.getFullYear():n},e.pretty_date=function(e){return moment(e).fromNow()},e.base_url=function(e,t){var r;return null==t&&(t=!1),null!=(r=this.site)?r.base_url(e,t):void 0},e.conf=function(e){var t;return null!=(t=this.site)?t.conf(e):void 0},e.get_conf=function(){var e;return null!=(e=this.site)?e.config:void 0},e.prototype.load_environment_config=function(){var e,t,r,i;i=o+"/app/conf/"+this.env+".conf",e=s.readFileSync(i,"UTF-8");try{if(r=JSON.parse(e),this.config=n.extend(this.config,r),this.config.debug)return console.log(this.env+" config loaded")}catch(u){if(t=u,this.config.debug)return console.log("error! parsing json in "+this.env+" conf")}},e.prototype.before_ready=function(){return 1},e.prototype.setup=function(){var r,n;for(r in t)n=t[r],this[r]=n;return this.configure_app(),this.router=new e.Router(this.app),this.setup_mongoose(),this.setup_routes(),this.listener=this.app.listen(this.config.port),this.listener?this.config.debug&&console.log("Express server listening on port %d in %s mode",this.listener.address().port,this.app.settings.env):this.config.debug&&console.log("listener did not start"),this.before_ready(),this.is_setup=!0,this.ready()},e.prototype.ready=function(){return 1},e.prototype.setup_mongoose=function(){return this.mongoose.connect("mongodb://"+this.conf("db_host")+"/"+this.conf("db_name"))},e.prototype.conf=function(e){var t;return null!=e&&(null!=(t=this.config)?t.hasOwnProperty(e):void 0)?this.config[e]:!1},e.prototype.base_url=function(e,t){var r;return null==e&&(e="/"),null==t&&(t=!1),"development"!==u.env.NODE_ENV||t?r=""+this.conf("base_url")+e:e},e.prototype.route=function(t,r,n){var o,i,s,u,a,d;if(null==n&&(n="get"),s="index",a="#",u=r.split(a),i=u[0].substr(0,1).toUpperCase()+u[0].substring(1),o=e[i+"Controller"],null==o)return this.config.debug?console.log("App route error, controller not found: "+i):!1;switch(d=null!=u[1]?u[1]:s,n){case"get":return this.router.get(t,o,d);case"post":return this.router.post(t,o,d)}},e.prototype.setup_routes=function(){return this.route("/sitemap","sitemap"),this.route("/post/:slug","post#index"),this.route("/category/:category","listing#by_category"),this.route("/tag/:tag","listing#by_tag"),this.route("/blog","listing#latest"),this.route("/store","store"),this.route("/about-me","home#about"),this.route("/","home")},e.prototype.configure_app=function(){return i=i,this.app.configure(function(e){return function(){return e.always_configure()}}(this)),this.app.configure("development",function(e){return function(){return e.app.use(i.errorHandler({dumpExceptions:!0,showStack:!0})),e.configure_for_development()}}(this)),this.app.configure("production",function(e){return function(){return e.app.use(i.errorHandler()),e.configure_for_production()}}(this)),this.is_configured=!0},e.prototype.always_configure=function(){return this.app.set("views",o+"/views"),this.app.set("view engine","jade"),this.app.use(i.bodyParser()),this.app.use(i.methodOverride()),this.app.use(this.app.router),this.app.use(i["static"](o+"/public"))},e.prototype.configure_for_development=function(){return 1},e.prototype.configure_for_production=function(){return 1},e}(),e.Schemas={},r=t.Schema,e.Schemas.Project=new r({title:{type:String,required:!0},order:{type:Number,"default":0},slug:{type:String,require:!0,unique:!0},description:{type:String,"default":""},display_url:{type:String,"default":""},full_url:{type:String,defalut:""},technologies:{type:r.Types.Mixed,"default":[]},images:{type:r.Types.Mixed,"default":[]},archived:{type:Boolean,"default":!1},group:{type:String,"default":"default"}}),e.Models={Project:t.mongoose.model("Project",e.Schemas.Project)},e.Router=function(){function e(e,t){if(this.app=e,this.opts=null!=t?t:{},!this.app)throw new Error("an app is required to create a Router");this.routes=[]}return e.debug=!1,e.prototype.register=function(t,r,n,o){var i;return e.debug&&console.log("router: add_route "+t.toUpperCase()+" "+r+", "+n.name+"#"+o),i=[t,r,n,o],this.routes.push(i),this.app[t](r,function(e){return function(t,r){var i;return i=new n(t,r),i["do"](o)?void 0:(console.error("method '"+o+"' not found for controller "+n),e.do_404(r))}}(this)),i},e.prototype.do_404=function(e){return e.status(404).send("Sorry, page not found!")},e.prototype.get=function(e,t,r){return this.register("get",e,t,r)},e.prototype.post=function(e,t,r){return this.register("post",e,t,r)},e.prototype.add_routes=function(e){var t,r,o,i,s;o=e.routes,i=[];for(r in o)s=o[r],t={type:"get",path:r,controller:e,method:null},n.isObject(s)?t=n.extend(t,s):t.method=s,i.push(this.register(t.type,t.path,t.controller,t.method));return i},e}(),e.View=function(){function t(e,t,r,n){this.data=null!=e?e:{},this.req=t,this.res=r,this.app=n,this.js_opts={},this.default_data(),this.set_view(this.data.view)}return t.prototype.default_data=function(){return this.data=n.extend({layout:!0,title:e.conf("site_name"),site_name:e.conf("site_name"),meta:{keywords:e.conf("site_keywords"),description:e.conf("site_description")},this_url:this.req.url,_:n,view:"index",disqus_shortname:e.conf("disqus_shortname"),cookies:null,body_class:"",single_upload_view:!1,this_url:this.req.url,pagination_data:{},uploads_filter:{},load_more:!0,display_comments:!1,no_uploads_message:!1,css_version:e.conf("css_version"),js_version:e.conf("js_version"),base_url:e.base_url(),auto_generated_id:this.auto_generate_id(),js_opts:this.js_opts,compiled_js:!1},this.data),this.data},t.prototype.auto_generate_id=function(){return"auto_id_"+(new Date).getTime().toString(36)},t.prototype.add_js_opts=function(e){return null==e&&(e={}),this.js_opts=n.extend(this.js_opts,e)},t.prototype.set_view=function(e){this.view=e},t.prototype.set_data=function(e,t){return this.data[e]=t},t.prototype.extend_data=function(e){return null==e&&(e={}),this.data=n.extend(this.data,e)},t.prototype.js_block=function(){return!1},t.prototype.render=function(){return this.data.js_opts&&this.add_js_opts(this.data.js_opts),this.data.compiled_js=this.js_block(),this.res.render(this.view,n.extend(e.get_conf(),this.data,{js_opts:JSON.stringify(this.js_opts)}))},t}(),e.Controller=function(){function t(e,t){this.req=e,this.res=t,this.requirements_list={},this.loaded_items=[],this.current_needs=[],this.public_methods=[],this.view_data={},this.view_to_render="",this.setup()}return t.prototype.name="base",t.prototype.view_class=e.View,t.prototype.setup=function(){return this.setup_preload()},t.prototype.setup_preload=function(){return 1},t.prototype.requires=function(e,t){var r,o,i,s,u,a,d,c,l,h;if(null==t&&(t="all"),n.isArray(e)||(e=[e]),r=function(e){return function(t,r){return e.requirements_list[t]=null!=e.requirements_list[t]?n.union(e.requirements_list[t],r):r}}(this),n.isObject(t)){for(d=null!=t.except?n.difference(this.public_methods,t.except):null!=t.only?n.intersection(this.public_methods,t.only):void 0,l=[],o=0,s=d.length;s>o;o++)a=d[o],l.push(r(a,e));return l}if("all"===t){for(c=this.public_methods,h=[],i=0,u=c.length;u>i;i++)a=c[i],h.push(r(a,e));return h}return r(t,e)},t.prototype.preload=function(e){return null==this.requirements_list[e]?!0:(this.current_needs=this.requirements_list[e],this.load(this.current_needs.join(" ")))},t.prototype["do"]=function(e,t){return this.requested_method=e,this.prevent_render=null!=t?t:!0,this.preload(this.requested_method),this.has_needs_met()?null!=this[this.requested_method]&&n.indexOf(this.public_methods,this.requested_method)>-1?(this[this.requested_method](),this.prevent_render||this.render()):(console.log("method not found or not public",this.name+"::"+this.requested_method),this.do_404()):setTimeout(function(e){return function(){return e["do"](e.requested_method,e.prevent_render)}}(this),50),!0},t.prototype.do_404=function(){return this.res.status(404),this.res.render("404",{title:" 404, man"})},t.prototype.param=function(e){return this.req.params.hasOwnProperty(e)?this.req.params[e]:!1},t.prototype.query=function(e){return this.req.query.hasOwnProperty(e)?this.req.query[e]:!1},t.prototype.cookie=function(e){return this.req.cookies&&this.req.cookies.hasOwnProperty(e)?this.req.cookies[e]:!1},t.prototype.body=function(e){return this.req.body&&this.req.body.hasOwnProperty(e)?this.req.body[e]:!1},t.prototype.redirect=function(e,t){return null==t&&(t=302),this.res.redirect(t,e)},t.prototype.load=function(e){var t,r,n,i;if(this.loaded_items){for(i=this.loaded_items,r=0,n=i.length;n>r;r++)t=i[r],e=e.replace(""+t,"");e=o.trim(e.replace(/\s\s/g,""))}else this.loaded_items=[];return e.length?!0:!1},t.prototype.loaded=function(e){return this.loaded_items||(this.loaded_items=[]),this.loaded_items.push(e)},t.prototype.has_needs_met=function(){var e,t,r,o,i;if(n.isEmpty(this.current_needs))return!0;for(e=!0,i=this.current_needs,t=0,r=i.length;r>t;t++)o=i[t],e=e&&n.indexOf(this.loaded_items,o)>-1;return e},t.prototype.json=function(e){return this.res.json(e)},t.prototype.render=function(e,t){return null==e&&(e=null),null==t&&(t=this.view_data),this.view_class?(this.before_render(),this.cancel_render?this.cancel_render=!1:(this.view_data.view=n.isEmpty(e)?n.isEmpty(this.view_to_render)?this.requested_method:this.view_to_render:e,this.current_view=new this.view_class(this.view_data,this.req,this.res,this.app),this.current_view.render(),this.after_render(),this.cancel_render=!1,this.current_view)):!1},t.prototype.set_view=function(e){return this.view_to_render=e,1},t.prototype.before_render=function(){return 1},t.prototype.after_render=function(){return 1},t}(),s=require("expect.js"),u={env:{NODE_ENV:"test"}},i=null,a={configure:function(){return 1},listen:function(){return 0},get:function(){return 1},post:function(){return 1}},l={connect:function(){return this.connected=!0}},t.mongoose=l,d=null,describe("App",function(){return before(function(){return i=e.init({app:a,mongoose:l})}),describe("#setup",function(){return it("should be configured",function(){return s(i.is_configured).to.equal(!0)}),it("should attempt to connect mongoose",function(){return s(i.mongoose.connected).to.equal(!0)}),it("should be set up",function(){return s(i.is_setup).to.equal(!0)})}),describe("#base_url",function(){return it("should return the root url when called with no parameters",function(){return s(i.base_url(null,!0)).to.equal("http://testingbaseurl.com/")}),it("should apped a URI when passed",function(){return s(i.base_url("/hotsauce",!0)).to.equal("http://testingbaseurl.com/hotsauce")})}),describe("#conf",function(){return it("should lookup a value by key",function(){return s(i.conf("meta_keywords")).to.equal("meta keywords value")}),it("should return false for a key that isn't found",function(){return s(i.conf("jibberjabber")).to.equal(!1)}),it("should return false by default",function(){return s(i.conf()).to.equal(!1)})})}),c=null,h={params:{key1:1,key2:2},query:{key1:1,key2:2},cookies:{key1:1,key2:2},body:{key1:1,key2:2}},p={status:function(e){this.status=e},render:function(e,t){this.view_name=e,this.view_data=t},redirect:function(e,t){this.redirect_status=e,this.redirect_dest=t},json:function(e){this.json_data=e}},describe("App.Controller",function(){var t,r,n,o;for(beforeEach(function(){return c=new e.Controller(h,p)}),describe("#set_view",function(){return it("sets the view",function(){return c.set_view("jibberjabber"),s(c.view_to_render).to.equal("jibberjabber")})}),describe("#do_404",function(){return before(function(){return c.do_404()}),it("sets status to 404",function(){return s(p.status).to.equal(404)}),it("set the view to 404",function(){return s(p.view_name).to.be("404")})}),t=["param","query","cookie","body"],r=0,n=t.length;n>r;r++)o=t[r],describe("#"+o,function(){return it("returns false by default",function(){return s(c[o]()).to.equal(!1)}),it("returns false for an invalid key",function(){return s(c[o]("hoozah")).to.equal(!1)}),it("returns a param value by key",function(){return s(c[o]("key1")).to.equal(1)})});return describe("#redirect",function(){return it("should set the destination",function(){return c.redirect("/somewhere_else"),s(p.redirect_dest).to.be("/somewhere_else")}),it("should set the status to 302 by default",function(){return c.redirect("/blahblah"),s(p.redirect_status).to.be(302)}),it("should set the status to anything requested",function(){return c.redirect("/blahblah",404),s(p.redirect_status).to.be(404)})}),describe("#requires",function(){return beforeEach(function(){var e,t,r,n;for(n=["pub_method1","pub_method2","pub_method3"],e=0,t=n.length;t>e;e++)r=n[e],c[r]=function(){return 1};return c.public_methods=n}),it("should have no requirements by default",function(){return s(c.requirements_list).to.be.empty()}),it("should add requirements for 'all' by default",function(){var e,t,r,n,o;for(c.requires("apples"),n=c.requirements_list,o=[],e=0,t=n.length;t>e;e++)r=n[e],o.push(s(r).to.contain("apples"));return o}),it("should add requirements for the requested method only",function(){return c.requires("apples"),c.requires("bananas","pub_method1"),s(c.requirements_list.pub_method1).to.contain("bananas"),s(c.requirements_list.pub_method2).to.not.contain("bananas")}),it("should add requirements to only the methods requested",function(){return c.requires("apples"),c.requires("oranges",{only:["pub_method1","pub_method2"]}),s(c.requirements_list.pub_method1).to.contain("oranges"),s(c.requirements_list.pub_method3).to.not.contain("oranges")}),it("should add requirements to all the methods except where requested",function(){return c.requires("apples"),c.requires("strawberries",{except:["pub_method1","pub_method2"]}),s(c.requirements_list.pub_method1).to.not.contain("strawberries"),s(c.requirements_list.pub_method3).to.contain("strawberries")})}),describe("#loaded",function(){return it("should add to loaded_items",function(){return s(c.loaded_items).to.not.contain("onions"),c.loaded("onions"),s(c.loaded_items).to.contain("onions")})}),describe("#has_needs_met",function(){return before(function(){return c.pina_colada=function(){},c.load=function(e){this.load_needs=e}}),it("should be ok when there are no current needs",function(){return s(c.has_needs_met()).to.be.ok()}),it("should set current_needs for requested method",function(){return c.requires(["pineapples","coconuts"],"pina_colada"),c.preload("pina_colada"),s(c.current_needs.join("")).to.be(["pineapples","coconuts"].join("")),it("should have called load with needs list",function(){return s(c.load_needs).to.be("pineapples coconuts")})})}),describe("#preload",function(){return before(function(){return c.load=function(e){return this.loaded(e)},c.requires("watermelon","testload")}),it("should be ok if a method has no requirements",function(){return s(c.preload("methodwithnorequirements")).to.be.ok()}),it("should load a missing requirement"),it("should give up trying to load after timeout is reached if needs aren't met"),it("should be able to load multiple items")}),describe("#json",function(){return it("should send json",function(){return c.json({some:"obj"}),s(JSON.stringify(p.json_data)).to.be(JSON.stringify({some:"obj"}))})}),describe("#render",function(){return it("should render the requested method by default",function(){var e;return c.requested_method="onion_rings",e=c.render(),s(e).to.be.ok(),s(c.view_data.view).to.be("onion_rings")}),it("should render the view_to_render when set",function(){var e;return c.view_to_render="pineapple_rings",e=c.render(),s(e).to.be.ok(),s(c.view_data.view).to.be("pineapple_rings")}),it("should render a requested view",function(){var e;return e=c.render("index"),s(e).to.be.ok(),s(c.view_data.view).to.be("index")}),it("should not render when cancelled",function(){var e;return c.cancel_render=!0,e=c.render("index"),s(e).to.be(!1)}),it("should not render when there is no view class",function(){var e;return c.view_class=null,e=c.render("index"),s(e).to.be(!1)})})}),f=null,describe("App.Router",function(){return beforeEach(function(){return f=new e.Router(a)}),describe("#constructor",function(){return it("should throw an error when no app is passed",function(){var t;return t=function(){return new e.Router},s(t).to.throwException(/app is required/)})}),describe("#register",function(){return it("should store a route when registered",function(){var t,r;return t=new e.Controller,r=f.register("get","/get_cake",t,"cake"),s(r[1]).to.eql("/get_cake")}),it("should store a route as GET by default",function(){var t,r;return t=new e.Controller,r=f.register("get","/get_cake",t,"cake"),s(r[0]).to.eql("get")}),it("should store a route as POST when requested",function(){var t,r;return t=new e.Controller,r=f.register("post","/eat_cake",t,"eat_cake"),s(r[0]).to.eql("post"),s(r[1]).to.eql("/eat_cake")})}),describe("#do_404",function(){return it("should set the status to 404",function(){var e;return e={status:function(e){return this.page_status=e,{send:function(){}}}},f.do_404(e),s(e.page_status).to.be(404)})}),describe("#get",function(){return it("should register a new route as get",function(){var e;return e=f.get("/whateverman",{},"whateverman"),s(e[0]).to.be("get"),s(e[1]).to.be("/whateverman")})}),describe("#post",function(){return it("should register a new route as post",function(){var e;return e=f.post("/anchorman",{},"anchorman"),s(e[0]).to.be("post"),s(e[1]).to.be("/anchorman")})})}),_=null,describe("App.View",function(){return beforeEach(function(){var t,r;return t={url:""},r={render:function(e){this.view_to_render=e}},i={},_=new e.View({},t,r,i)}),it("should autogenerate a unique id",function(e){var t;return t=_.auto_generate_id(),setTimeout(function(){var r;return r=_.auto_generate_id(),s(t.length).to.be.greaterThan(1),s(t).to.not.be(r),e()},5)}),it("should be able to add to js_opts",function(){return s(_.js_opts).to.not.have.key("plum"),_.add_js_opts({plum:"purple"}),s(_.js_opts).to.have.key("plum")}),it("should set the view",function(){return _.set_view("blender"),s(_.view).to.be("blender")}),it("should be able to set some data",function(){return s(_.data).to.not.have.key("mangos"),_.set_data("mangos",5),s(_.data).to.have.key("mangos"),s(_.data.mangos).to.be(5)}),it("should be able to extend existing data",function(){return s(_.data).to.not.have.keys("kiwi","plantain"),_.extend_data({kiwi:!0,plantain:!0}),s(_.data).to.have.keys("kiwi","plantain"),s(_.data.kiwi).to.be(!0),s(_.data.plantain).to.be(!0)}),it("should not contain a js_block by default",function(){return s(_.js_block()).to.be(!1)})})}).call(this);